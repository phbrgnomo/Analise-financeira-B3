% Generated by BMad create-story workflow
# Story 3.4: cli-health-metrics-commands-metrics-test-conn

Status: ready-for-dev

<!-- Note: Validation is optional. Run validate-create-story for quality check before dev-story. -->

## Story

As a Usuário/Operador (CLI),
I want a set of CLI commands (`main --test-conn --provider <name>` and `main --metrics` / `main --health`) to test provider connectivity and expose basic health/metrics information,
so that I can verify provider connectivity and system health before running ingest jobs and diagnose issues quickly.

## Acceptance Criteria

1. `poetry run main --test-conn --provider <provider>` returns exit code 0 when provider connectivity succeeds and non‑zero otherwise; prints a concise JSON summary containing `provider`, `status`, `latency_ms`, `last_success_at` (if available) and `error` (if any).
2. `poetry run main --metrics` prints basic operational metrics (e.g., `job_latency_ms`, `rows_fetched`, `error_rate`) in human-readable and optional JSON forms (`--json`).
3. `poetry run main --health` returns quick health summary for local DB and key folders (`dados`, `raw`, `snapshots`) and indicates status `ok|warn|error` with reasons.
4. Commands support `--timeout` and respect global retry/backoff policy from config/env; failures are logged to `ingest_logs` with structured fields when appropriate.
5. Unit tests cover CLI parsing and command behavior (mocking provider adapters) and an integration-style smoke test validates a mocked successful `--test-conn` response.
6. Outputs and logs follow project observability standards (JSON-structured logs, ISO8601 timestamps, `job_id` where applicable).

## Tasks / Subtasks

- [ ] Implement CLI entrypoints in `src/cli.py` / `src/main.py`:
  - [ ] Add `test_conn` command implementing `--provider`, `--timeout`, `--json` flags.
  - [ ] Add `metrics` and `health` commands with `--json` output option.
- [ ] Add health/metrics helpers in `src/utils/health.py` and `src/utils/metrics.py`.
- [ ] Implement provider connectivity check in adapter base: add `Adapter.check_connection()` contract and implement in critical adapters (yfinance, alpha_vantage) in `src/adapters/`.
- [ ] Wire logging and structured output (use existing logging conventions; prefer JSON logger wrapper in `src/utils/logging.py`).
- [ ] Add tests:
  - [ ] `tests/test_cli_test_conn.py` (unit, mocking adapters)
  - [ ] `tests/test_cli_health_metrics.py` (smoke, DB health checks using fixtures)
- [ ] Update docs: add usage examples in `docs/playbooks/quickstart-ticker.md` and `docs/implementation-artifacts/3-4-cli-health-metrics-commands-metrics-test-conn.md` (this file).

## Dev Notes

- Architecture patterns and constraints:
  - Use existing DB contract `db.read_prices` and health checks should not perform heavy reads; prefer lightweight metadata queries (e.g., count, existence checks).
  - Respect single-user SQLite constraints: health should check DB file presence and owner permissions (`chmod 600`) rather than open heavy concurrent writes.
  - Provider `check_connection()` should be non-destructive and limited to a single lightweight request (e.g., provider ping endpoint or HEAD request where available) and must respect `RETRY_BACKOFF` environment settings.
- Source tree components to touch:
  - `src/cli.py` or `src/main.py` (Typer entrypoints)
  - `src/adapters/*` (add `check_connection()` implementations)
  - `src/utils/health.py`, `src/utils/metrics.py`, `src/utils/logging.py`
  - `tests/test_cli_*.py`
- Testing standards summary:
  - Unit tests mock adapter network calls; integration smoke tests use fixtures (`tests/fixtures/sample_ticker.csv`) and a temporary SQLite DB provided by `tests/conftest.py`.

### Project Structure Notes

- File locations (recommended):
  - CLI: `src/cli.py` (Typer)
  - Health/metrics helpers: `src/utils/health.py`, `src/utils/metrics.py`
  - Adapter checks: `src/adapters/<provider>_adapter.py` (implement `check_connection()`)
  - Tests: `tests/test_cli_test_conn.py`, `tests/test_cli_health_metrics.py`

### References

- Source: docs/planning-artifacts/epics.md (FR17, FR39, FR16)
- Architecture constraints: docs/planning-artifacts/architecture.md
- Sprint tracking: docs/implementation-artifacts/sprint-status.yaml

## Dev Agent Record

### Agent Model Used

GPT-5 mini

### Debug Log References

- Generated by BMad create-story workflow; see file list and sprint-status update.

### Completion Notes List

- Story document created and saved at `docs/implementation-artifacts/3-4-cli-health-metrics-commands-metrics-test-conn.md`.

### File List

- src/cli.py (new/updated)
- src/utils/health.py (new)
- src/utils/metrics.py (new)
- src/adapters/* (update: add check_connection implementations)
- tests/test_cli_test_conn.py (new)
- tests/test_cli_health_metrics.py (new)

