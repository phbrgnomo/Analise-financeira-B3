---
title: "Story 1.2: Implementar Canonical Mapper (Provider -> Schema canônico)"
author: Phbr
status: ready-for-dev
story_key: 1-2-implementar-canonical-mapper-provider-schema-canonico
created: 2026-02-17T00:00:00Z
---

# Story 1.2: Implementar Canonical Mapper (Provider -> Schema canônico)

Status: ready-for-dev

## Story

As a Developer,
I want a canonical mapper that normalizes provider DataFrames to the project's canonical schema,
so that downstream modules can rely on a consistent format for persistence and processing.

## Acceptance Criteria

1. Given a raw `DataFrame` from a provider adapter (e.g., `yfinance`), when the canonical mapper is executed, then it returns a `DataFrame` with canonical columns: `ticker`, `date`, `open`, `high`, `low`, `close`, `adj_close`, `volume`, `source`, `fetched_at`.
2. The mapper computes `raw_checksum` (SHA256) for the raw payload and includes it in metadata persisted alongside canonical rows.
3. `fetched_at` is normalized to UTC ISO8601 and time zone handling is documented.
4. The mapper provides a lightweight `pandera` schema used to validate canonical `DataFrame` in unit tests and CI.
5. Mapper has clear error handling and returns descriptive errors when required columns are missing or types are invalid.

## Tasks / Subtasks

- [ ] Implement `src/etl/mapper.py` with `to_canonical(df, provider_name, ticker)` returning canonical `DataFrame`.
  - [ ] Compute and attach `raw_checksum` (SHA256) for the raw payload; persist or return as metadata.
  - [ ] Normalize `fetched_at` to UTC ISO8601 in `metadata` column(s).
  - [ ] Implement `pandera` `DataFrameSchema` for canonical schema and integrate validation call.
- [ ] Add unit tests `tests/test_mapper.py` covering:
  - [ ] Successful mapping from `yfinance`-like input to canonical schema.
  - [ ] Handling of missing columns (fail with clear error code/message).
  - [ ] `raw_checksum` correctness for example payloads.
- [ ] Document mapping examples in `docs/planning-artifacts/adapter-mappings.md` (yfinance → canonical example).
- [ ] Add integration smoke test (mock provider) to verify canonical output shape used by DB layer.

## Dev Notes

- Technical stack: follow project architecture conventions (see docs/planning-artifacts/architecture.md). Use `pandas` for transformations, `pandera` for DataFrame validation, `pydantic` for config objects if needed, and `python-dotenv` for env.
- Persisting raw checksum and canonical rows: mapper should return canonical `DataFrame` plus metadata required by `src/db/db.py` (upsert by `(ticker, date)`).
- Error handling: raise typed exceptions (e.g., `MappingError`) with structured message to be consumed by `pipeline.ingest`.
- Timezones: normalize all datetimes to UTC with timezone-aware ISO8601 (e.g., `2026-02-17T12:34:56Z`). Document decisions in the mapper docstring.
- File permissions: follow architecture guidance for file writes; raw files and DB should document recommended permissions (owner-only for DB). See architecture.md.

### Project Structure Notes

- `src/etl/mapper.py` — canonical mapper implementation and `pandera` schema.
- `src/adapters/` — provider adapters supply raw `DataFrame` and `source` metadata (e.g., `yfinance_adapter.py`).
- `src/db/db.py` — DB helpers that expect canonical `DataFrame` shape for upsert.
- `docs/planning-artifacts/adapter-mappings.md` — add mapping examples for `yfinance`.

### References

- Source: docs/planning-artifacts/epics.md#story-1.2
- Architecture: docs/planning-artifacts/architecture.md
- Adapter mappings: docs/planning-artifacts/adapter-mappings.md

## Dev Agent Record

### Agent Model Used

GPT-5 mini

### Debug Log References

- Generated by workflow: _bmad/bmm/workflows/4-implementation/create-story

### Completion Notes List

- Story file created and marked ready-for-dev; includes acceptance criteria, tasks, and developer guardrails.

### File List

- docs/implementation-artifacts/1-2-implementar-canonical-mapper-provider-schema-canonico.md
