---
story_key: 4-5-integracao-simples-de-alerting-e-thresholds-operacionais
epic: 4
story_num: 5
title: Integração simples de alerting e thresholds operacionais
status: ready-for-dev
created_by: Phbr
created_at: 2026-02-17T00:00:00Z
---

# Story 4.5: Integração simples de alerting e thresholds operacionais

Status: ready-for-dev

## Story

As an Operator,
I want simple alert rules (scripted) for key thresholds (ingest-lag, high error-rate),
so that I am notified when operational SLAs are violated.

## Acceptance Criteria

1. Given metrics are available from `main metrics`, when `ingest-lag` &gt; configurable threshold (default 24h) or `error-rate` &gt; configurable threshold, then an alert script emits a standardized message to stdout and exits with code 2 (or triggers an external webhook if configured).
2. Alerting rules are documented in `docs/operations/alerts.md` with suggested thresholds and runbook.
3. Alert script supports configuration via environment variables: `ALERTING_ENABLED` (default `false`), `ALERT_WEBHOOK_URL` (optional), `METRICS_INGEST_LAG_THRESHOLD` (seconds, default `86400`), and `ALERT_ERROR_RATE_THRESHOLD` (percentage, default `5`).
4. Alerts are idempotent and include `job_id`, `ticker` (if applicable), `metric`, `value`, `threshold`, `timestamp` and `severity` in JSON when `--format json` is used.
5. Exit codes: `0` = OK/no alert, `1` = warning, `2` = critical (alert emitted).

## Tasks / Subtasks

- [ ] Implement `scripts/alerts.py` with CLI entrypoint `poetry run main alerts` (or `poetry run main alert-check`).
  - [ ] Implement config parsing (ENV + CLI) and defaults.
  - [ ] Implement metrics query abstraction calling existing `main metrics` internals (or read from DB) with `--format json` support.
  - [ ] Implement evaluation of thresholds and emit JSON/plain messages.
  - [ ] Implement optional `--webhook` mode to POST alert payload to `ALERT_WEBHOOK_URL` with retry/backoff and circuit-breaker safety (disabled by default).
- [ ] Add `docs/operations/alerts.md` with examples, default thresholds, runbook and sample outputs.
- [ ] Add unit tests under `tests/test_alerts.py` validating exit codes, message format, ENV overrides and `--no-network` fixtures.
- [ ] Wire alert script into CI smoke job (optional): `--no-network` mode using fixtures to simulate triggered and non-triggered cases.

## Dev Notes

- Use existing `main metrics --format json` schema (see `docs/planning-artifacts/epics.md`) as input; prefer programmatic library call rather than shelling out if module API available.
- Default thresholds and ENV names (align with Epic 4 operational defaults):
  - `METRICS_INGEST_LAG_THRESHOLD=86400` (seconds)
  - `ALERT_ERROR_RATE_THRESHOLD=5` (percent)
  - `ALERTING_ENABLED=false`
  - `ALERT_WEBHOOK_URL=` (optional)
- Alerts must include `job_id` and be traceable to `ingest_logs` entries when applicable.
- Keep operations code defensive: timeouts, retries with jitter, and non-blocking webhook attempts (best-effort, do not block main pipelines).
- Respect feature flag `ALERTING_ENABLED` — default false to avoid noisy early alerts in dev environments.

### Project Structure Notes

- Suggested placement: CLI wiring in `src/main.py`, implementation in `src/ops/alerts.py` (or `src/operations/alerts.py`), tests in `tests/` and docs in `docs/operations/alerts.md`.
- Follow existing code patterns (Typer-based CLI, logging structured JSON). Reuse `ingest_logs` DB/schema and `main.metrics` logic where possible to avoid duplication.

### References

- Source: docs/planning-artifacts/epics.md#Epic-4-%E2%80%94-Operações-&-Observabilidade (Story 4.5)
- Operational defaults: docs/planning-artifacts/epics.md (METRICS_INGEST_LAG_THRESHOLD, ALERTING_ENABLED)

## Dev Agent Record

### Agent Model Used

GPT-5 mini (assistant-generated)

### Debug Log References

- Generated by create-story workflow (BMad automated run) on 2026-02-17

### Completion Notes List

- Story created and marked `ready-for-dev` from sprint-status.yaml

### File List

- docs/implementation-artifacts/4-5-integracao-simples-de-alerting-e-thresholds-operacionais.md
