---
title: "5.6 Expandir Canonical Mapper para suportar provedores adicionais e transformações"
epic: 5
story: 6
story_key: 5-6-expandir-canonical-mapper-para-suportar-provedores-adicionais-e-transformacoes
status: ready-for-dev
owner: Dev
created: 2026-02-17T00:00:00Z
---

# Story 5.6: Expandir Canonical Mapper para suportar provedores adicionais e transformações

Status: ready-for-dev

## Story

As a Developer,
I want the canonical mapper to include provider-specific transformation hooks,
so that differences (timezone, adjusted close handling) are centralized and tested.

## Acceptance Criteria

1. Given raw DataFrame(s) from different providers, when the canonical mapper executes, then it applies provider-specific hooks to produce identical canonical schema rows for the same underlying market data.
2. Unit tests demonstrate equivalence for at least one sample ticker between two providers using fixtures (`--no-network` mode).
3. Provider-specific mappings are documented in `docs/planning-artifacts/adapter-mappings.md` with examples and test fixtures referenced.
4. Canonical mapper exposes clear extension points (hooks) per provider and validates outputs against `pandera` schema.

## Tasks / Subtasks

- [ ] Implement provider hook interface in `src/etl/canonical_mapper.py` (API: `register_provider_hook(provider_name, func)`)
  - [ ] Add default normalizers for `yfinance` and `alphavantage` that handle timezone normalization and `adj_close` handling
  - [ ] Implement `raw_checksum` computation and include in metadata
- [ ] Add unit tests in `tests/etl/test_canonical_mapper.py` validating equivalence between providers using fixtures in `tests/fixtures/providers/`
- [ ] Update `docs/planning-artifacts/adapter-mappings.md` with provider mapping examples and a small recipe for adding new providers
- [ ] Add example provider config in `config/providers.example.yaml` (fields: name, priority, timeouts, use_fixture)
- [ ] Ensure `pipeline.ingest` respects provider hooks when present and runs in `--no-network` mode with fixtures

## Dev Notes

- Relevant architecture patterns and constraints:
  - Canonical mapper lives under `src/etl/` and must produce rows matching DB contract (`prices` table schema)
  - Follow existing project conventions: use `pandas` for ETL, `pandera` for DataFrame validation, `pydantic` for config parsing
  - Maintain idempotency: compute and persist `raw_checksum` and use upsert by `(ticker,date)` when writing to DB

- Source tree components likely to be touched:
  - `src/etl/canonical_mapper.py` (new)
  - `src/adapters/*` (adapter outputs used for mapping)
  - `tests/fixtures/providers/` (add representative CSV/DF fixtures)
  - `tests/etl/test_canonical_mapper.py` (new tests)
  - `docs/planning-artifacts/adapter-mappings.md` (documentation updates)

### Provider-specific considerations

- Timezones: normalize `fetched_at` to UTC ISO8601 and ensure `date` column is consistent across providers (document edge cases)
- `adj_close` semantics: provide explicit transformation and equivalence notes; test with known sample where providers differ
- Rate-limit metadata: mapper should not implement retries, but should record provider metadata (attempts, retry_after) when present

### Project Structure Notes

- Alignment with unified project structure:
  - ETL/canonical mapper: `src/etl/`
  - Adapter implementations: `src/adapters/` (keep provider-specific modules)
  - Tests: `tests/etl/` and `tests/fixtures/providers/`
- Detected conflicts or variances:
  - None detected in repo; follow existing patterns from `src/` and tests layout in `tests/`

### References

- Source: docs/planning-artifacts/epics.md#Story-5.6-Expandir-Canonical-Mapper-para-suportar-provedores-adicionais-e-transformacoes
- Relevant architecture guidance: docs/planning-artifacts/architecture.md (Adapter -> Canonical Mapper)

## Dev Agent Record

### Agent Model Used

GPT-5 mini

### Debug Log References

- Generated by create-story workflow (BMad)

### Completion Notes List

- Ultimate context engine analysis completed for story 5.6

### File List

- src/etl/canonical_mapper.py (new)
- tests/etl/test_canonical_mapper.py (new)
- tests/fixtures/providers/sample_yfinance.csv (example fixture)
- docs/planning-artifacts/adapter-mappings.md (updated)


---

Issue: https://github.com/phbrgnomo/Analise-financeira-B3/issues/
