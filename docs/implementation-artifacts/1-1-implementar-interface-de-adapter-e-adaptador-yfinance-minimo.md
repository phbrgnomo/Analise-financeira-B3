<!-- Generated by BMad create-story workflow -->
# Story 1.1: Implementar interface de Adapter e adaptador yfinance mínimo

Status: review

## Story

As a Desenvolvedor,
I want uma interface mínima `Adapter` e um adaptador `yfinance` que retorne um `pandas.DataFrame`,
so that a pipeline de ingest consiga obter preços para um ticker a partir de um provider.

## Acceptance Criteria

1. `Adapter.fetch(ticker) -> pd.DataFrame` está definido como contrato público (interface/base class)
2. Adaptador `yfinance` implementa `Adapter.fetch` e retorna um `DataFrame` com colunas brutas do provedor e metadado `source`
3. Adaptador possui tratamento básico de erros e retorna mensagens de erro descritivas em exceções documentadas
4. Documentação curta descreve o esquema de saída esperado e os códigos/mensagens de erro

## Tasks / Subtasks

- [x] Definir `Adapter` abstrato em `src/adapters/base.py` com método `fetch(ticker) -> pd.DataFrame`
  - [x] Especificar contrato de erros/exception custom (ex.: `AdapterError`)
 - [x] Implementar `src/adapters/yfinance_adapter.py` com `YFinanceAdapter(Adapter)` usando `yfinance` (`yf.download`) com wrapper/stub para testes
  - [x] Garantir que retorna `DataFrame` e adiciona `source` no atributo/metadata
  - [x] Implementar logging estruturado e retries simples (3 tentativas, backoff exponencial mínimo). ValidationError não faz retry.
- [x] Escrever docstring e um pequeno README de uso em `docs/implementation-artifacts/1-1-implementar-interface-de-adapter-e-adaptador-yfinance-minimo.md#references`
- [x] Adicionar/atualizar testes unitários em `tests/test_adapters.py` que mockam o wrapper `web.DataReader`/`yfinance` e validam esquema de saída
- [x] Documentar o que foi implantado nessa etapa em `docs/sprint-reports` conforme definido no FR28 (`docs/planning-artifacts/prd.md`)

## Dev Notes

- Linguagem/plataforma: Python 3.12 (seguir `pyproject.toml` do projeto).
- Bibliotecas recomendadas: `pandas`, `yfinance`, `typing`, `pytest` para testes.
- Arquitetura: separar `adapters/` (interfaces + providers) e `mappers/` (canonical mapping) conforme `docs/planning-artifacts/epics.md`.
- Erros: criar `src/adapters/errors.py` com `AdapterError` (mensagem, code, original_exception) para padronizar tratamento.
- Logging: usar logging estruturado (JSON) com campos mínimos: `ticker`, `provider`, `attempt`, `job_id`, `status`, `error_message`.

### Requisitos técnicos importantes (guardrails)

- Interface clara: `Adapter.fetch(ticker: str) -> pd.DataFrame` e não faz persistência; somente retorna dados brutos.
- Não persistir aqui: salvar raw / persistência fica para Story 1.4 / 1.6; este adaptador apenas entrega `DataFrame` e metadados.
- Timezones: normalize `fetched_at` em UTC ISO8601 quando disponível; documentar formato.
- Tests: adicionar unit test que verifica `DataFrame` contém pelo menos as colunas `['Open','High','Low','Close','Adj Close','Volume']` ou equivalente do provedor.

### File Structure Notes

- Proposta de arquivos a criar/ajustar:
  - `src/adapters/__init__.py`
  - `src/adapters/base.py` (Adapter interface)
  - `src/adapters/errors.py` (AdapterError)
  - `src/adapters/yfinance_adapter.py` (YFinanceAdapter)
  - `tests/test_adapters.py` (unit tests)
- Mantenha imports absolutos do pacote `src` e registre módulos no `pyproject.toml` entrypoint conforme convenção do projeto.

### Testing Requirements

- Unit tests: mockar chamadas a `yfinance` (via wrapper `web.DataReader`) para garantir determinismo; testar erros e sucesso.
- Coverage mínima para esta story: testes para interface, adaptador e tratamento de erro.

### References

- Fonte primária: docs/planning-artifacts/epics.md (Epic 1 — Story 1.1)
- Requisitos arquiteturais: docs/planning-artifacts/architecture.md

## Dev Agent Record

### Agent Model Used

GPT-5 mini

### Completion Notes List

- Implementado Adapter abstrato e adaptador mínimo para Yahoo Finance (`yfinance`) com importação tolerante a ambiente e suporte a mocks em testes.
- Alterações técnicas principais:
  - Refatoração: importação local/tolerante de `yfinance` para evitar falha em tempo de import quando dependências do sistema não estão presentes.
  - Tratamento: `ValidationError` agora é considerado não-transitório e é re-lançado sem retry.
  - Testes: suite de testes atualizada/compatibilizada; mocks usados para isolar chamadas de rede.
- Commits relevantes:
  - 920816b — "Refatorar YFinanceAdapter: importação lazy de yfinance, permitir mocks em testes e tratar ValidationError sem retry"


### File List

- Modified: `src/adapters/yfinance_adapter.py` — refatorado; commit 920816b
- Modified: `docs/implementation-artifacts/1-1-implementar-interface-de-adapter-e-adaptador-yfinance-minimo.md` — status e registros atualizados
- Existing: `src/adapters/base.py`
- Existing: `src/adapters/errors.py`
- Existing: `tests/test_adapters.py` (testes atualizados)


<!-- end file -->

Issue: https://github.com/phbrgnomo/Analise-financeira-B3/issues/114
