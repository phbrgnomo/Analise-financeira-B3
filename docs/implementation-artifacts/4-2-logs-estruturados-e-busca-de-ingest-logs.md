# Story 4.2: Logs estruturados e busca de ingest_logs

Status: ready-for-dev

## Story

As an Operator/Developer,
I want structured JSON logs and a CLI to query `ingest_logs`,
so that failures and historical ingest activity can be audited and traced.

## Acceptance Criteria

1. Given ingests have been executed and `ingest_logs` populated
   When the operator runs `poetry run main logs --ticker PETR4.SA --since 2026-02-01 --format json`
   Then the CLI returns structured JSON log entries with fields (`ticker`, `job_id`, `started_at`, `finished_at`, `rows_fetched`, `status`, `error_message`, `duration_ms`).
2. A query for failures returns non-zero exit code and a short summary to stdout.
3. The CLI accepts pagination flags `--limit <N>` and `--offset <N>` for large result sets.
4. Logs include additional fields: `provider` (nullable), `attempt` (int), `status_code` (nullable), `retry_after` (nullable), `duration_ms` to enable correlation.
5. Unit and integration tests cover parsing/formatting, pagination, and exit code behavior (use `--no-network` CI fixtures).
6. Documentation in `docs/operations/runbook.md` shows example commands and expected JSON output schema.

## Tasks / Subtasks

- [ ] Design JSON schema for `ingest_logs` and document it (schema file in `docs/operations/`)
- [ ] Add `ingest_logs` storage: (a) DB table `ingest_logs` schema migration; (b) optional NDJSON log file `logs/ingest/<date>.ndjson`
- [ ] Implement structured logging helper `src/observability/logging.py` to emit NDJSON and DB inserts
- [ ] Implement CLI command `main logs` in `src/main.py` / `src/cli/logs.py` with `--ticker`, `--since`, `--format`, `--limit`, `--offset`
- [ ] Add tests under `tests/` and fixtures under `tests/fixtures/` to validate outputs and exit codes
- [ ] Update `docs/operations/runbook.md` with examples, and add quick examples to README
- [ ] Add CI smoke test that runs `poetry run main --no-network --ticker PETR4.SA --format json` against fixtures and asserts schema

## Dev Notes

- JSON schema (minimum fields): `ticker`, `job_id` (uuid), `provider` (nullable), `attempt` (int), `started_at` (RFC3339 UTC), `finished_at` (RFC3339 UTC), `rows_fetched` (int), `status` (string: success/failure), `status_code` (nullable), `error_message` (nullable), `retry_after` (nullable, seconds), `duration_ms` (int).
- Store authoritative records in SQLite `dados/data.db` table `ingest_logs` for queryability and retention; emit lightweight NDJSON logs to `logs/ingest/` for operational streaming if desired.
- CLI should read DB by default; `--format json` emits newline-delimited JSON or a JSON array when `--array` flag passed. Default pagination: `--limit 100`.
- Use `uuid.uuid4()` for `job_id` and ensure `started_at`/`finished_at` in UTC. Use `datetime.now(tz=timezone.utc).isoformat()`.
- Ensure all writes that create new files (backups, logs) apply safe atomic-write pattern (write temp -> rename) and set `chmod 600` where appropriate for sensitive artifacts.

### Project Structure Notes

- Implementation files:
  - `src/observability/logging.py` — structured logging helpers and DB persistence
  - `src/cli/logs.py` — CLI handler for `main logs` (imported in `src/main.py`)
  - `src/db/migrations/` — migration adding `ingest_logs` table and indexes on `ticker`, `started_at`
  - `docs/operations/runbook.md` — runbook and examples
  - `tests/test_logs_cli.py` and fixtures in `tests/fixtures/`

### References

- Epic definition and acceptance criteria: [docs/planning-artifacts/epics.md](docs/planning-artifacts/epics.md)
- Operational defaults and JSON examples: [docs/planning-artifacts/epics.md](docs/planning-artifacts/epics.md#L796)

## Dev Agent Record

### Agent Model Used

GPT-5 mini

### Debug Log References

- Generated by automated create-story workflow; see `docs/implementation-artifacts/sprint-status.yaml` for status change.

### Completion Notes List

- Story file created and saved to `docs/implementation-artifacts/4-2-logs-estruturados-e-busca-de-ingest-logs.md`.

### File List

- `src/observability/logging.py` (suggested)
- `src/cli/logs.py` (suggested)
- `src/db/migrations/` (suggested)
- `docs/operations/runbook.md` (update suggested)
